@using Students_Portal_App.Models.Entities
@model List<StudentsPortalInfos>

@{
    ViewData["Title"] = "Students Dashboard";

    var today = DateTime.Today;
    var totalStudents = ViewBag.TotalStudents as int? ?? Model.Count;

    var activeIds = ViewBag.ActiveTodayIds as List<int> ?? new List<int>();

    // Active / Inactive today based on attendance
    var activeTodayList = Model.Where(s => activeIds.Contains(s.StudentId)).ToList();
    var inactiveTodayList = Model.Where(s => !activeIds.Contains(s.StudentId)).ToList();

    var activeTodayCount = activeTodayList.Count;
    var inactiveTodayCount = totalStudents - activeTodayCount;

    //Monthly students status chart
    var studentsMonthly = Model
        .Where(s => s.InTime.HasValue &&
                    s.InTime.Value.Month == today.Month &&
                    s.InTime.Value.Year == today.Year)
        .ToList();

    var activeMonthlyList = studentsMonthly.Where(s => s.StudentStatus == "Active").ToList();
    var inactiveMonthlyList = studentsMonthly.Where(s => s.StudentStatus != "Active").ToList();

    var activeMonthlyCount = activeMonthlyList.Count;
    var inactiveMonthlyCount = totalStudents - activeMonthlyCount;

    /* Department Details */
    var departmentToday = activeTodayList
        .Where(s => s.Department != null)
        .GroupBy(s => s.Department.DepartmentName)
        .Select(g => new
        {
            Department = g.Key,
            Count = g.Count(),
            Students = g.Select(x => x.StudentName).ToList()
        }).ToList();

    var departmentMonthly = studentsMonthly
        .Where(s => s.Department != null)
        .GroupBy(s => s.Department.DepartmentName)
        .Select(g => new
        {
            Department = g.Key,
            Count = g.Count(),
            Students = g.Select(x => x.StudentName).ToList()
        }).ToList();
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .card-box {
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    .legend-container .d-flex {
        font-size: 14px;
        margin-bottom: 6px;
    }

    .legend-container i {
        cursor: pointer;
        color: #6c757d;
    }

    .popover-body {
        max-height: 150px;
        overflow-y: auto;
    }
</style>

<h4 class="mb-3">
    Strength of Students :
    <span class="fw-bold text-primary">@totalStudents</span>
</h4>

<div class="mb-3">
    <label class="me-3">
        <input type="radio" name="statusType" value="current" checked /> Current
    </label>
    <label>
        <input type="radio" name="statusType" value="monthly" /> Monthly
    </label>
</div>

<!-- Charts -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card card-box p-4">
            <h5>Students Status</h5>
            <canvas id="studentsStatusChart" style="max-height:150px;"></canvas>
            <div id="studentsStatusLegends" class="mt-3 legend-container"></div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-box p-4">
            <h5>Department Details</h5>
            <canvas id="departmentChart" style="max-height:150px;"></canvas>
            <div id="departmentLegends" class="mt-3 legend-container"></div>
        </div>
    </div>
</div>

<!-- Students Table -->
<div class="card card-box p-4">
    <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
        <h5>Students List</h5>
        <div class="btn-group">
            <a asp-action="AddStudent" class="btn btn-primary">Add Student</a>
            <a asp-action="AddPaper" class="btn btn-primary">Add Papers</a>
            <a asp-action="ViewPaper" class="btn btn-primary">View Papers</a>
            <a asp-action="AddScholarship" class="btn btn-primary">Add Scholarship</a>
            <a asp-action="ViewScholarship" class="btn btn-primary">View Scholarship</a>
            <a asp-action="Dashboard" class="btn btn-primary">View Dashboard</a>
        </div>
    </div>

    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Student ID</th>
                <th>Register No</th>
                <th>Profile</th>
                <th>Status</th>
                <th>Name</th>
                <th>Department</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var student in Model)
            {
                <tr id="student-row-@student.StudentId">
                    <td>@student.StudentId</td>
                    <td>@student.RegisterNumber</td>
                    <td>
                        @if (!string.IsNullOrEmpty(student.PhotoPath))
                        {
                            <img src="@student.PhotoPath" style="width:45px;height:45px;object-fit:cover;border-radius:50%;" />
                        }
                    </td>
                    <td>@student.StudentStatus</td>
                    <td>@student.StudentName</td>
                    <td>@student.Department?.DepartmentName</td>
                    <td>
                        <span>@student.InTime?.ToString("hh:mm tt")</span>
                        <a href="javascript:void(0);" data-bs-toggle="modal" data-bs-target="#editTimeModal-@student.StudentId">
                            <i class="fas fa-clock ms-1"></i>
                        </a>
                    </td>
                    <td>@student.OutTime?.ToString("hh:mm tt")</td>
                    <td class="d-flex gap-1">
                        <a asp-action="EditStudent" asp-route-studentId="@student.StudentId" class="btn btn-warning btn-sm"><i class="fas fa-edit"></i></a>
                        <form asp-action="DeleteStudent" asp-route-studentId="@student.StudentId" method="post" onsubmit="return confirm('Are you sure?');">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                        </form>
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#attendanceModal-@student.StudentId" title="Mark Attendance">
                            <i class="fas fa-user-check"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Attendance Modals -->
@foreach (var student in Model)
{
    <div class="modal fade" id="attendanceModal-@student.StudentId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="attendance-form" data-student-id="@student.StudentId">
                    <div class="modal-header">
                        <h5 class="modal-title">Mark Attendance - @student.StudentName</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label>In Time</label>
                        <input type="datetime-local" name="inTime" class="form-control mb-2" value="@student.InTime?.ToString("yyyy-MM-ddTHH:mm")" />
                        <label>Out Time</label>
                        <input type="datetime-local" name="outTime" class="form-control" value="@student.OutTime?.ToString("yyyy-MM-ddTHH:mm")" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save Attendance</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(function() {
        var activeTodayCount = @activeTodayCount;
        var inactiveTodayCount = @inactiveTodayCount;
        var activeMonthlyCount = @activeMonthlyCount;
        var inactiveMonthlyCount = @inactiveMonthlyCount;

        var activeTodayNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(activeTodayList.Select(x => x.StudentName)));
        var inactiveTodayNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(inactiveTodayList.Select(x => x.StudentName)));
        var activeMonthlyNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(activeMonthlyList.Select(x => x.StudentName)));
        var inactiveMonthlyNames = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(inactiveMonthlyList.Select(x => x.StudentName)));

        var deptToday = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(departmentToday));
        var deptMonthly = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(departmentMonthly));

        //Students status chart
        var statusChart = new Chart(document.getElementById("studentsStatusChart"), {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Inactive'],
                datasets: [{ data: [activeTodayCount, inactiveTodayCount], backgroundColor: ['#ffc107', '#dc3545'] }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        function updateStatusLegend(active, inactive, activeNames, inactiveNames, colors) {
            var container = $("#studentsStatusLegends").empty();
            function row(label, count, color, names) {
                var el = $(`<div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:${color};display:inline-block;margin-right:8px;"></span>
                    <span>${label}: ${count}</span>
                    <i class="fas fa-info-circle ms-2" data-bs-toggle="popover" data-bs-html="true"></i>
                </div>`);
                el.find("i").attr("data-bs-content", names.length ? names.join("<br>") : `Total: ${count}`);
                container.append(el);
            }
            row("Active", active, colors[0], activeNames);
            row("Inactive", inactive, colors[1], inactiveNames);
            document.querySelectorAll('[data-bs-toggle="popover"]').forEach(el => new bootstrap.Popover(el, { trigger: 'hover', html: true }));
        }

        updateStatusLegend(activeTodayCount, inactiveTodayCount, activeTodayNames, inactiveTodayNames, ['#ffc107', '#dc3545']);

        // --- Department Chart with High / Medium / Low ---
        function buildDepartmentChart(departments) {
            var high = departments.filter(d => d.Count >= 5);
            var medium = departments.filter(d => d.Count >= 2 && d.Count < 5);
            var low = departments.filter(d => d.Count < 1);

            var categories = [
                { label: "High", depts: high },
                { label: "Medium", depts: medium },
                { label: "Low", depts: low }
            ];

            var labels = categories.map(c => c.label);
            var counts = categories.map(c => c.depts.length);
            var colors = ['#198754', '#ffc107', '#dc3545'];

            if (window.deptChart) window.deptChart.destroy();
            window.deptChart = new Chart(document.getElementById("departmentChart"), {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: counts, backgroundColor: colors }] },
                options: { plugins: { legend: { display: false } } }
            });

            var legend = $("#departmentLegends").empty();
            categories.forEach((c, i) => {
                var deptNames = c.depts.map(d => d.Department);
                var row = $(`<div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px;"></span>
                    <span>${c.label}: ${c.depts.length}</span>
                    <i class="fas fa-info-circle ms-2" data-bs-toggle="popover" data-bs-html="true"></i>
                </div>`);
                row.find("i").attr("data-bs-content", deptNames.length ? deptNames.join("<br>") : `No departments`);
                legend.append(row);
            });

            document.querySelectorAll('#departmentLegends [data-bs-toggle="popover"]').forEach(el =>
                new bootstrap.Popover(el, { trigger: 'hover', html: true })
            );
        }

        buildDepartmentChart(deptToday);

        $('input[name="statusType"]').change(function() {
            if (this.value === "current") {
                statusChart.data.datasets[0].data = [activeTodayCount, inactiveTodayCount];
                statusChart.data.datasets[0].backgroundColor = ['#ffc107', '#dc3545'];
                statusChart.update();
                updateStatusLegend(activeTodayCount, inactiveTodayCount, activeTodayNames, inactiveTodayNames, ['#ffc107', '#dc3545']);
                buildDepartmentChart(deptToday);
            } else {
                statusChart.data.datasets[0].data = [activeMonthlyCount, inactiveMonthlyCount];
                statusChart.data.datasets[0].backgroundColor = ['#6f42c1', '#000'];
                statusChart.update();
                updateStatusLegend(activeMonthlyCount, inactiveMonthlyCount, activeMonthlyNames, inactiveMonthlyNames, ['#6f42c1', '#000']);
                buildDepartmentChart(deptMonthly);
            }
        });

        // Attendance AJAX
        $(document).on("submit", ".attendance-form", function(e) {
            e.preventDefault();
            var form = $(this);
            var studentId = form.data("student-id");

            $.post("/Student/MarkAttendance", {
                studentId: studentId,
                inTime: form.find("[name='inTime']").val(),
                outTime: form.find("[name='outTime']").val()
            }).done(function(data) {
                var modalEl = document.getElementById('attendanceModal-' + studentId);
                bootstrap.Modal.getOrCreateInstance(modalEl).hide();

                activeTodayCount = data.activeCount;
                inactiveTodayCount = totalStudents - data.activeCount;
                activeTodayNames = data.activeNames;
                inactiveTodayNames = data.inactiveNames;

                statusChart.data.datasets[0].data = [activeTodayCount, inactiveTodayCount];
                statusChart.update();
                updateStatusLegend(activeTodayCount, inactiveTodayCount, activeTodayNames, inactiveTodayNames, ['#ffc107', '#dc3545']);

                buildDepartmentChart(data.department);
            }).fail(function(err) {
                console.error("Attendance update failed:", err);
                alert("Failed to mark attendance. Please try again.");
            });
        });
    });
</script>
