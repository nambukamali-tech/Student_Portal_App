@using Students_Portal_App.DTOs
@model Students_Portal_App.ViewModels.IndexViewModel

@{
    ViewData["Title"] = "Staff Dashboard";
    var attendance = Model.AttendanceSummary;
    var totalStudents = Model.TotalStudents;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .card-box {
        border-radius: 16px;
        box-shadow: 0 8px 24px rgba(0,0,0,.06);
    }

    .legend-container .d-flex {
        font-size: 14px;
        margin-bottom: 6px;
    }

    .legend-container i {
        cursor: pointer;
        color: #6c757d;
    }

    .popover-body {
        max-height: 150px;
        overflow-y: auto;
    }

    img.profile-pic {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        object-fit: cover;
    }
</style>

<div class="row mb-4">

    <!-- Students Status Chart -->
    <div class="col-md-6">
        <h5>ADMIN DASHBOARD</h5>
        <div class="card card-box p-4">
            <h5>Students Status</h5>

            <div class="d-flex justify-content-between mb-3 flex-wrap">
                <div>
                    <input type="radio" id="statusToday" name="statusType" value="current" checked />
                    <label for="statusToday" class="me-2">Today</label>

                    <input type="radio" id="statusMonthly" name="statusType" value="monthly" />
                    <label for="statusMonthly">Current Month</label>
                </div>
            </div>

            <select id="departmentFilter" class="form-select w-50 mb-2">
                <option value="">All Departments</option>
                @foreach (var dept in Model.Departments)
                {
                    <option value="@dept">@dept</option>
                }
            </select>

            <div style="height:250px; width:100%;">
                <canvas id="studentsStatusChart"></canvas>
            </div>

            <div id="studentsStatusLegends" class="mt-3 legend-container"></div>
        </div>
    </div>

    <!-- Department Strength Chart -->
    <div class="col-md-6">
        <div class="card card-box p-4">
            <h5>Department Status</h5>

            <div style="height:250px; width:100%;">
                <canvas id="departmentChart"></canvas>
            </div>

            <div id="departmentLegends" class="mt-3 legend-container"></div>
        </div>
    </div>
</div>

<!-- Students List Table -->
<div class="card card-box p-4">
    <div class="d-flex justify-content-between mb-3 flex-wrap gap-2">
        <h5>Students List</h5>
        <div class="btn-group flex-wrap">
            <a asp-controller="User" asp-action="AddUser" class="btn btn-primary">Add Users</a>
            <a asp-action="AddStudent" class="btn btn-primary">Add Student</a>
            <a asp-controller="Paper" asp-action="AddPaper" class="btn btn-primary">Add Papers</a>
            <a asp-controller="Paper" asp-action="ViewPaper" class="btn btn-primary">View Papers</a>
            <a asp-controller="Scholarship" asp-action="AddScholarship" class="btn btn-primary">Add Scholarship</a>
            <a asp-controller="Dashboard" asp-action="Dashboard" class="btn btn-primary">View Dashboard</a>
        </div>
    </div>

    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Student ID</th>
                <th>Profile</th>
                <th>Register No</th>
                <th>Status</th>
                <th>Name</th>
                <th>Department</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var student in Model.StudentsAttendance)
            {
                <tr id="student-row-@student.StudentId">
                    <td>@student.StudentId</td>
                    <td><img src="@student.PhotoPath" class="profile-pic" onerror="this.src='/images/default-user.png';" /></td>
                    <td>@student.RegisterNumber</td>
                    <td>@(student.InTime.HasValue ? "Present" : "Absent")</td>
                    <td>@student.StudentName</td>
                    <td>@student.DepartmentName</td>
                    <td>@(student.InTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td>@(student.OutTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td class="d-flex gap-1">
                        <a asp-action="EditStudent" asp-route-studentId="@student.StudentId" class="btn btn-warning btn-sm"><i class="fas fa-edit"></i></a>
                        <form asp-action="DeleteStudent" asp-route-studentId="@student.StudentId" method="post" onsubmit="return confirm('Are you sure?');">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-danger btn-sm"><i class="fas fa-trash"></i></button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Attendance Modals -->
@foreach (var student in Model.StudentsAttendance)
{
    <div class="modal fade" id="attendanceModal-@student.StudentId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="attendance-form" data-student-id="@student.StudentId">
                    <div class="modal-header">
                        <h5 class="modal-title">Mark Attendance - @student.StudentName - @DateTime.Today:yyyy-MM-dd</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label>In Time</label>
                        <input type="time" name="inTime" class="form-control mb-2" value="@student.InTime?.ToString("HH:mm")" />
                        <label>Out Time</label>
                        <input type="time" name="outTime" class="form-control" value="@student.OutTime?.ToString("HH:mm")" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save Attendance</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    $(document).ready(function () {

        let currentType = 'current'; // 'current' = Today, 'monthly' = Current Month
        let selectedDepartment = "";
        let statusChart = null;

        // Helper: update legend with student names
        function updateStatusLegend(counts, names, labels, colors) {
            const container = $("#studentsStatusLegends").empty();
            counts.forEach((count, i) => {
                const studentNames = names[i] || [];
                const el = $(`
                    <div class="d-flex align-items-center mb-1">
                        <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px"></span>
                        <span>${labels[i]}: ${count}</span>
                        <i class="fas fa-info-circle ms-2" data-bs-toggle="popover" data-bs-html="true"></i>
                    </div>
                `);
                el.find("i").attr("data-bs-content", studentNames.length ? studentNames.join("<br>") : `Total: ${count}`);
                container.append(el);
            });
            $('[data-bs-toggle="popover"]').popover({ trigger: 'hover', html: true });
        }

        // Load Students Status Chart dynamically
        function loadStatusChart() {
            $.get('/Student/GetDepartmentStatus', { department: selectedDepartment })
                .done(function (res) {
                    if (!res) return;

                    // Decide Today or Monthly counts
                    const counts = currentType === "monthly"
                        ? [res.MonthlyActiveCount, res.MonthlyInactiveCount]
                        : [res.ActiveCount, res.InactiveCount];

                    const names = currentType === "monthly"
                        ? [res.MonthlyActiveNames, res.MonthlyInactiveNames]
                        : [res.ActiveNames, res.InactiveNames];

                    const labels = currentType === "monthly"
                        ? ['Present', 'Absent']
                        : ['Active', 'Inactive'];

                    const colors = currentType === "monthly"
                        ? ['#6f42c1', '#000000']
                        : ['#ffc107', '#dc3545'];

                    // Destroy old chart if exists
                    if (statusChart) statusChart.destroy();

                    // Draw chart
                    const ctx = document.getElementById("studentsStatusChart").getContext('2d');
                    statusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: labels, datasets: [{ data: counts, backgroundColor: colors }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            layout: { padding: 10 }
                        }
                    });

                    // Update legend with names
                    updateStatusLegend(counts, names, labels, colors);
                })
                .fail(function () { console.error("Failed to load department status data."); });
        }

        // Initial load
        loadStatusChart();

        // Toggle Today / Monthly
        $('input[name="statusType"]').change(function () {
            currentType = this.value;
            loadStatusChart();
        });

        // Department filter dropdown
        $('#departmentFilter').change(function () {
            selectedDepartment = $(this).val();
            loadStatusChart();
        });

        // ===== Department Strength Chart (static) =====
        (function loadDepartmentChart() {
            const departments = @Html.Raw(
                                Model.AttendanceSummary.Departments != null
                                        ? System.Text.Json.JsonSerializer.Serialize(Model.AttendanceSummary.Departments)
                                        : "[]"
                        );

            if (!departments || departments.length === 0) return;

            const labels = departments.map(d => d.DepartmentName);
            const counts = departments.map(d => d.Count);
            const colors = labels.map((_, i) => `hsl(${i * 45 % 360},70%,55%)`);

            const ctx = document.getElementById("departmentChart").getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: counts, backgroundColor: colors }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    layout: { padding: 10 }
                }
            });

            const legend = $("#departmentLegends").empty();
            departments.forEach((d, i) => {
                legend.append(`
                    <div class="d-flex align-items-center mb-1">
                        <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px"></span>
                        <span>${d.DepartmentName}: ${d.Count}</span>
                    </div>
                `);
            });
        })();

    });
</script>

