@using Students_Portal_App.DTOs
@model Students_Portal_App.ViewModels.StaffDashboardViewModel

@{
    ViewData["Title"] = "Staff Dashboard";
    var totalStudents = Model.TotalStudents;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .card-box { border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .legend-container .d-flex { font-size:14px; margin-bottom:6px; }
    .legend-container i { cursor:pointer; color:#6c757d; }
    .popover-body { max-height:150px; overflow-y:auto; }
    img.profile-pic { width:45px; height:45px; border-radius:50%; object-fit:cover; }
</style>

<div class="row mb-4">
    <div class="col-12 mb-4">
        <h5>STAFF DASHBOARD - @Model.StaffDepartment Department</h5>
        <div class="card card-box p-4">
            <h5>Students Status</h5>

            <div class="mb-2">
                <input type="radio" id="statusToday" name="statusType" value="today" checked />
                <label for="statusToday" class="me-2">Today</label>

                <input type="radio" id="statusMonthly" name="statusType" value="monthly" />
                <label for="statusMonthly">Current Month</label>
            </div>

            <canvas id="studentsStatusChart" style="max-height:200px"></canvas>
            <div id="studentsStatusLegends" class="mt-3 legend-container"></div>
        </div>
    </div>
</div>

<div class="card card-box p-4">
    <div class="d-flex justify-content-between mb-3">
        <h5>Students List</h5>
        <a asp-controller="Dashboard" asp-action="Dashboard" class="btn btn-primary">View Dashboard</a>
    </div>

    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Student ID</th>
                <th>Profile</th>
                <th>Register No</th>
                <th>Status</th>
                <th>Name</th>
                <th>Department</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var student in Model.StudentsAttendance)
            {
                <tr data-student-id="@student.StudentId">
                    <td>@student.StudentId</td>
                    <td><img src="@student.PhotoPath" class="profile-pic" onerror="this.src='/images/default-user.png';" /></td>
                    <td>@student.RegisterNumber</td>
                    <td>@(student.InTime.HasValue ? "Present" : "Absent")</td>
                    <td>@student.StudentName</td>
                    <td>@student.DepartmentName</td>
                    <td>@(student.InTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td>@(student.OutTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td>
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#attendanceModal-@student.StudentId">
                            <i class="fas fa-user-check"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@foreach (var student in Model.StudentsAttendance)
{
    <div class="modal fade" id="attendanceModal-@student.StudentId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="attendance-form" data-student-id="@student.StudentId">
                    <div class="modal-header">
                        <h5 class="modal-title">Mark Attendance - @student.StudentName - @DateTime.Today.ToString("yyyy-MM-dd")</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label>In Time</label>
                        <input type="time" name="inTime" class="form-control mb-2" value="@student.InTime?.ToString("HH:mm")" />
                        <label>Out Time</label>
                        <input type="time" name="outTime" class="form-control" value="@student.OutTime?.ToString("HH:mm")" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save Attendance</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(function() {
    const totalStudents = @Model.TotalStudents;

    // Prepare initial data
    let studentsToday = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.StudentsAttendance.Select(s => new {
            s.StudentId,
            s.StudentName,
            s.StudentStatus,
            s.InTime,
            s.OutTime
        }).ToList()
    ));

    let studentsMonthly = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.MonthlyStudentsAttendance.Select(s => new {
            s.StudentId,
            s.StudentName,
            s.StudentStatus,
            s.InTime,
            s.OutTime
        }).ToList()
    ));

    let currentType = 'today';
    let currentStudents = studentsToday;

    const chartLabelsToday = ['Active', 'Inactive'];
    const chartColorsToday = ['#ffc107', '#dc3545'];

    const chartLabelsMonthly = ['Present', 'Absent'];
    const chartColorsMonthly = ['#8a2be2', '#000000'];

        function getCounts(data, type) {
        if (type === 'today') {
            return [
                data.filter(s => s.InTime).length,                 
                data.filter(s => !s.InTime).length                 
            ];
        } else {
            return [
                data.filter(s => s.InTime).length,                 
                data.filter(s => !s.InTime).length
            ];
        }
    }


    let statusChart = new Chart(document.getElementById("studentsStatusChart").getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: chartLabelsToday,
            datasets: [{
                data: getCounts(currentStudents, 'today'),
                backgroundColor: chartColorsToday
            }]
        },
        options: { plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: false }
    });

       function updateLegend(data, type) {
        const container = $("#studentsStatusLegends").empty();
        const labels = type === 'monthly' ? chartLabelsMonthly : chartLabelsToday;
        const colors = type === 'monthly' ? chartColorsMonthly : chartColorsToday;

        const activeCount = data.filter(s => s.InTime).length;
        const inactiveCount = data.filter(s => !s.InTime).length;

        labels.forEach((label, i) => {
            const count = i === 0 ? activeCount : inactiveCount;
            const names = data
                .filter(s => i === 0 ? s.InTime : !s.InTime)
                .map(s => s.StudentName);

            const el = $(`
                <div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px;"></span>
                    <span>${label}: ${count}</span>
                    <i class="fas fa-info-circle ms-2" data-bs-toggle="popover"></i>
                </div>
            `);

            el.find('i').attr(
                'data-bs-content',
                names.length ? names.join("<br>") : `Total: ${count}`
            );

            container.append(el);
        });

        container.append(`<div class="mt-2 fw-bold">Total: ${data.length}</div>`);
        $('[data-bs-toggle="popover"]').popover({ trigger: 'hover', html: true });
    }

    // Initialize legend
    updateLegend(currentStudents, 'today');

    // Radio switch
    $('input[name="statusType"]').change(function() {
        currentType = this.value === 'monthly' ? 'monthly' : 'today';
        currentStudents = currentType === 'monthly' ? studentsMonthly : studentsToday;
        statusChart.data.datasets[0].data = getCounts(currentStudents, currentType);
        statusChart.data.datasets[0].backgroundColor = currentType === 'monthly' ? chartColorsMonthly : chartColorsToday;
        statusChart.data.labels = currentType === 'monthly' ? chartLabelsMonthly : chartLabelsToday;
        statusChart.update();
        updateLegend(currentStudents, currentType);
    });

    $('.attendance-form').submit(function(e){
        e.preventDefault();
        const form = $(this);
        const studentId = form.data('student-id');
        const inTime = form.find('[name="inTime"]').val();
        const outTime = form.find('[name="outTime"]').val();

        $.ajax({
            type: "POST",
            url: "/Staff/MarkAttendance",
            data: { StudentId: studentId, InTime: inTime, OutTime: outTime },
            success: function(response){
                if(response.success){
                    const targetList = currentType === 'monthly' ? studentsMonthly : studentsToday;
                    const studentIndex = targetList.findIndex(s => s.StudentId == studentId);
                    if(studentIndex !== -1){
                        targetList[studentIndex].InTime = inTime;
                        targetList[studentIndex].OutTime = outTime;
                        targetList[studentIndex].StudentStatus = inTime ? (currentType==='monthly' ? 'Present' : 'Active') : (currentType==='monthly' ? 'Absent' : 'Inactive');
                    }

                    // Update chart and legend
                    statusChart.data.datasets[0].data = getCounts(targetList, currentType);
                    statusChart.update();
                    updateLegend(targetList, currentType);

                        const row = $(`tr[data-student-id='${studentId}']`);
                     if(row.length) 
                     {
                     row.find('td:nth-child(4)').text(inTime ? "Present" : "Absent");
                     row.find('td:nth-child(7)').text(inTime ? inTime : "-");
                     row.find('td:nth-child(8)').text(outTime ? outTime : "-");
                     }         
                    form.closest('.modal').modal('hide');
                    alert('Attendance saved successfully!');
                } else {
                    alert('Failed: ' + response.message);
                }
            },
            error: function(xhr){
                alert('Error: ' + (xhr.responseJSON?.message || xhr.statusText));
            }
        });
    });
});
</script>


