@using Students_Portal_App.DTOs
@model Students_Portal_App.ViewModels.StaffDashboardViewModel

@{
    ViewData["Title"] = "Staff Dashboard";
    var totalStudents = Model.TotalStudents;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

<style>
    .card-box { border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06);}
    .legend-container .d-flex { font-size:14px; margin-bottom:6px;}
    .legend-container i { cursor:pointer; color:#6c757d;}
    .popover-body { max-height:150px; overflow-y:auto;}
    img.profile-pic { width:45px;height:45px;border-radius:50%;object-fit:cover; }
</style>

<div class="row mb-4">
    <div class="col-md-6">
        <h5>STAFF DASHBOARD</h5>
        <div class="card card-box p-4">
            <h5>Students Status</h5>


            <div class="mb-2">
                <input type="radio" id="statusToday" name="statusType" value="current" checked />
                <label for="statusToday" class="me-2">Today</label>

                <input type="radio" id="statusMonthly" name="statusType" value="monthly" />
                <label for="statusMonthly">Current Month</label>
            </div>

            <select id="departmentFilter" class="form-select w-50 mb-3">
                <option value="">All Departments</option>
                @foreach (var dept in Model.Departments)
                {
                    <option value="@dept">@dept</option>
                }
            </select>

            <canvas id="studentsStatusChart" style="max-height:150px"></canvas>
            <div id="studentsStatusLegends" class="mt-3 legend-container"></div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-box p-4">
            <h5>Department Details</h5>
            <canvas id="departmentChart" style="max-height:150px"></canvas>
            <div id="departmentLegends" class="mt-3 legend-container"></div>
        </div>
    </div>
</div>

<div class="card card-box p-4">
    <div class="d-flex justify-content-between mb-3">
        <h5>Students List</h5>
        <a asp-controller="Dashboard" asp-action="Dashboard" class="btn btn-primary">View Dashboard</a>
    </div>

    <table class="table table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>Student ID</th>
                <th>Profile</th>
                <th>Register No</th>
                <th>Status</th>
                <th>Name</th>
                <th>Department</th>
                <th>In Time</th>
                <th>Out Time</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var student in Model.StudentsAttendance)
            {
                <tr>
                    <td>@student.StudentId</td>
                    <td><img src="@student.PhotoPath" class="profile-pic" onerror="this.src='/images/default-user.png';" /></td>
                    <td>@student.RegisterNumber</td>
                    <td>@(student.InTime.HasValue ? "Present" : "Absent")</td>
                    <td>@student.StudentName</td>
                    <td>@student.DepartmentName</td>
                    <td>@(student.InTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td>@(student.OutTime?.ToString("hh:mm tt") ?? "-")</td>
                    <td>
                        <button class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#attendanceModal-@student.StudentId">
                            <i class="fas fa-user-check"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@foreach (var student in Model.StudentsAttendance)
{
    <div class="modal fade" id="attendanceModal-@student.StudentId" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form class="attendance-form" data-student-id="@student.StudentId">
                    <div class="modal-header">
                        <h5 class="modal-title">Mark Attendance - @student.StudentName - @DateTime.Today.ToString("yyy-MM-dd")</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label>In Time</label>
                        <input type="time" name="inTime" class="form-control mb-2" value="@student.InTime?.ToString("HH:mm")" />
                        <label>Out Time</label>
                        <input type="time" name="outTime" class="form-control" value="@student.OutTime?.ToString("HH:mm")" />
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Save Attendance</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    const totalStudentsfromDB = @Model.TotalStudents; //newly added
$(function(){

    const students = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.StudentsAttendance.Select(s => new {
            StudentName = s.StudentName ?? "Unknown",
            Department = s.DepartmentName ?? "Unknown",
            StudentStatus = s.StudentStatus ?? "Inactive"
        }).ToList()
    ));

    const monthlyStudents = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
        Model.MonthlyStudentsAttendance.Select(s => new
            {
            StudentName = s.StudentName ?? "Unknown",
            Department = s.DepartmentName ?? "Unknown",
            StudentStatus = s.StudentStatus ?? "Inactive"
        }).ToList()
    ));

    let currentStudents = students; 

    let chartLabelsToday = ['Active','Inactive'];
    let chartColorsToday = ['#ffc107','#dc3545'];

    let chartLabelsMonthly = ['Present','Absent'];
    let chartColorsMonthly = ['#8a2be2','#000000'];

    function getCounts(filteredStudents){
        return [
            filteredStudents.filter(s => s.StudentStatus==='Active').length,
            filteredStudents.filter(s => s.StudentStatus==='Inactive').length
        ];
    }

    function getCountsMonthly(filteredStudents){
        return [
            filteredStudents.filter(s => s.StudentStatus==='Active').length,
            filteredStudents.filter(s => s.StudentStatus==='Inactive').length
        ];
    }

    let statusChart = new Chart(document.getElementById("studentsStatusChart").getContext('2d'), {
        type:'doughnut',
        data: {
            labels: chartLabelsToday,
            datasets: [{ data: getCounts(students), backgroundColor: chartColorsToday }]
        },
        options:{ plugins:{ legend:{ display:false } } }
    });

    //update legend
        function updateLegend(filteredStudents){
        const container = $("#studentsStatusLegends").empty();
        const isMonthly = $('input[name="statusType"]:checked').val() === "monthly";

        const labels = isMonthly ? chartLabelsMonthly : chartLabelsToday;
        const colors = isMonthly ? chartColorsMonthly : chartColorsToday;

        const selectedDept = $('#departmentFilter').val();

        const activeCount = filteredStudents.filter(s => s.StudentStatus === 'Active').length;
        const inactiveCount = filteredStudents.filter(s => s.StudentStatus === 'Inactive').length;
        const attendanceCount = activeCount + inactiveCount;
        const notMarkedCount = Math.max(totalStudentsfromDB - attendanceCount, 0);

        labels.forEach((label,i)=>{
            const count = (label === 'Active' || label === 'Present')
                ? activeCount
                : inactiveCount;

            const names = filteredStudents
                .filter(s =>
                    (label === 'Active' || label === 'Present')
                        ? s.StudentStatus === 'Active'
                        : s.StudentStatus === 'Inactive'
                )
                .map(s => s.StudentName);

            const el = $(`
                <div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px;"></span>
                    <span>${label}: ${count}</span>
                    <i class="fas fa-info-circle ms-2" data-bs-toggle="popover" data-bs-html="true"></i>
                </div>
            `);

            el.find('i').attr(
                'data-bs-content',
                names.length ? names.join("<br>") : `Total: ${count}`
            );

            container.append(el);
        });

        if (!selectedDept) {
            container.append(`
                <div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:#6c757d;display:inline-block;margin-right:8px;"></span>
                    <span>Not Marked: ${notMarkedCount}</span>
                    <i class="fas fa-info-circle ms-2"
                       data-bs-toggle="popover"
                       data-bs-html="true"
                       data-bs-content="Students with no attendance entry">
                    </i>
                </div>
            `);
        }

        const totalCount = selectedDept ? filteredStudents.length : totalStudentsfromDB;
        const totalLabel = selectedDept ? `Total (${selectedDept})` : `Total`;

        container.append(`
            <div class="d-flex align-items-center mt-2 fw-bold">
                <span>${totalLabel}: ${totalCount}</span>
            </div>
        `);

        $('[data-bs-toggle="popover"]').popover({ trigger:'hover', html:true });
    }


    updateLegend(students);

    function applyFilters(){
        const selectedDept = $('#departmentFilter').val();
        const filtered = selectedDept
            ? currentStudents.filter(s => s.Department === selectedDept)
            : currentStudents;

        const isMonthly = $('input[name="statusType"]:checked').val() === "monthly";

        statusChart.data.datasets[0].data = isMonthly
            ? getCountsMonthly(filtered)
            : getCounts(filtered);

        statusChart.data.datasets[0].backgroundColor = isMonthly ? chartColorsMonthly : chartColorsToday;
        statusChart.data.labels = isMonthly ? chartLabelsMonthly : chartLabelsToday;

        statusChart.update();
        updateLegend(filtered);
    }

    $('input[name="statusType"]').change(function(){
        currentStudents = this.value === "monthly" ? monthlyStudents : students;
        applyFilters();
    });

    $('#departmentFilter').change(applyFilters);
    

    $('.attendance-form').submit(function(e){
        e.preventDefault();
        const form = $(this);
        const studentId = form.data('student-id');
        const inTime = form.find('[name="inTime"]').val();
        const outTime = form.find('[name="outTime"]').val();

        $.post('/Staff/MarkAttendance',{StudentId:studentId,InTime:inTime,OutTime:outTime},function(){
            location.reload();
        });
    });

    const departments = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.AttendanceSummary.Departments ?? new List<Students_Portal_App.DTOs.DepartmentAttendanceDto>()));

    function buildDepartmentChart(depts){
        if(!depts || !depts.length) return;
        const labels = depts.map(d => d.DepartmentName);
        const counts = depts.map(d => d.Count);
        const colors = labels.map((_,i)=>`hsl(${i*50%360},70%,50%)`);
        if(window.deptChart) window.deptChart.destroy();
        window.deptChart = new Chart(document.getElementById("departmentChart").getContext('2d'),{
            type:'doughnut',
            data:{ labels, datasets:[{data:counts,backgroundColor:colors}] },
            options:{ plugins:{ legend:{ display:false } } }
        });

        const legend = $("#departmentLegends").empty();
        depts.forEach((d,i)=>{
            const row = $(`
                <div class="d-flex align-items-center mb-1">
                    <span style="width:15px;height:15px;background:${colors[i]};display:inline-block;margin-right:8px;"></span>
                    <span>${d.DepartmentName}: ${d.Count}</span>
                    <i class="fas fa-info-circle ms-2" data-bs-toggle="popover" data-bs-html="true"></i>
                </div>
            `);
            row.find("i").attr("data-bs-content", d.StudentNames.join("<br>"));
            legend.append(row);
        });
        $('[data-bs-toggle="popover"]').popover({ trigger:'hover', html:true });
    }
    buildDepartmentChart(departments);

});
</script>
